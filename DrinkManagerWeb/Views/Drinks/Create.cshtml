@model DrinkManagerWeb.Models.ViewModels.DrinkCreateViewModel

@{
    ViewBag.Title = Model == null ? "Create new drink" : $"Editing {Model.Name}";
    Layout = "_Layout";
}

<div class="row px-4">
    <div class="col-12">
        <h1>@(Model == null ? "Create new drink" : $"Editing {Model.Name}")</h1>
        <hr />
        <form asp-antiforgery="true" asp-action="Create" asp-controller="Drinks" asp-route-id="@(Model != null ? Model.Id : null)" method="post">
            <div class="row">
                <div class="form-group col-md-6">
                    <label asp-for="Name">Name</label>
                    <input type="text" class="form-control" asp-for="Name" placeholder="Name">
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="Category">Category</label>
                    <input type="text" class="form-control" asp-for="Category" placeholder="Category">
                    <span asp-validation-for="Category" class="text-danger"></span>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-6">
                    <label asp-for="AlcoholicInfo">Alcohol content</label>
                    <select class="form-control" asp-for="AlcoholicInfo">
                        <option>Alcoholic</option>
                        <option>Non alcoholic</option>
                        <option>Optional alcohol</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="GlassType">Glass type</label>
                    <input type="text" class="form-control" asp-for="GlassType" placeholder="Glass type">
                    <span asp-validation-for="GlassType" class="text-danger"></span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="Instructions">Instructions</label>
                        <textarea class="form-control mb-3" rows="3" asp-for="Instructions"></textarea>
                        <span asp-validation-for="Instructions" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="ImageUrl">Image Url</label>
                        <input type="text" class="form-control" asp-for="ImageUrl" placeholder="Image Url">
                        <span asp-validation-for="ImageUrl" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <div id="ingredients-group">
                        <label>Ingredients</label>
                        <div class="form-group mb-3">
                            <input type="text" class="form-control" asp-for="Ingredient1" placeholder="Ingredient">
                            <span asp-validation-for="Ingredient1" class="text-danger"></span>
                        </div>
                    </div>
                    <button type="button" onclick="AddInputAndRestartValidation()" class="btn btn-primary"><i class="fas fa-plus"></i> Add Ingredient</button>
                </div>
            </div>
            <div class="mt-3 border-top">
                <input class="btn btn-primary mt-3" type="submit" value="Save" />
            </div>
        </form>
    </div>
</div>




@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        function AddIngredientInput(value = "") {
            let ingredientNumber = $("#ingredients-group input").length + 1;
            if (ingredientNumber > 15) {
                if ($(".alert").length === 0) {
                    $("#ingredients-group").parent().append(
                        `<div class="mt-3 alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    You can add maximum of 15 ingredients.
                                </div>`);
                }
                return;
            }
            $("#ingredients-group").append(
                `<div class='form-group mb-3' id='Ingredient_${ingredientNumber}'>
                            <div class='d-flex'>
                                <input type="text" class="form-control" placeholder="Ingredient" data-val="true" data-val-length="The field Ingredient must be a string with a maximum length of 50." data-val-length-max="50" data-val-regex="Amount separated by space is required" data-val-regex-pattern=".*\\s.*" id="Ingredient${ingredientNumber}" maxlength="50" name="Ingredient${ingredientNumber}" value="${value}"/>
                                <button type="button" class="ml-3 btn btn-danger" onclick="$('#Ingredient_${ingredientNumber}').remove();$(this).remove()">&times;</button>
                            </div>
                            <span class="text-danger field-validation-valid" data-valmsg-for="Ingredient${ingredientNumber}" data-valmsg-replace="true"></span>
                        </div>`);


        }

        function AddInputAndRestartValidation() {
            AddIngredientInput();
            ReInitializeValidation();
        }

        function ReInitializeValidation() {
            let form = $("form").removeData("validator").removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse(form);
        }
    </script>


    @* Load ingredients from model into the form *@
    @if (Model != null)
    {

        foreach (var ingredient in Model.Ingredients)
        {
            @*First ingredient goes into the static input*@
            if (Model.Ingredients.IndexOf(ingredient) == 0)
            {
                <script>
                    $("#Ingredient1").val("@ingredient.Name @ingredient.Amount");
                </script>
            }
            else
            {
                @*Create dynamic inputs for all other ingredients*@
                <script>
                    AddIngredientInput("@ingredient.Name @ingredient.Amount");
                </script>
            }
        }

        <script>
            // Validation needs to be reinitialized for the ingredients inputs
            ReInitializeValidation();
        </script>
    }
}